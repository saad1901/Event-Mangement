{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }} - Tournament Central{% endblock %}

{% block content %}
    <!-- Event Header -->
    <section class="event-header" style="background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('{{ event.image }}');">
        <div class="container">
            <h1>{{ event.title }}</h1>
            <div class="event-meta" style="color: #ffffff;">
                <span><i class="far fa-calendar-alt"></i> {{ event.date }}</span>
                <span><i class="far fa-clock"></i> {{ event.time }}</span>
                <span><i class="fas fa-map-marker-alt"></i> {{ event.location }}</span>
            </div>
        </div>
    </section>

    <!-- Event Details -->
    <section class="event-detail-section">
        <div class="container">
            <div class="event-detail-content">
                <div class="event-description">
                    <h2>About This Event</h2>
                    <p>{{ event.description }}</p>
                    
                    <div class="event-info-grid">
                        <div class="event-info-item">
                            <h3>Category</h3>
                            <p>{{ event.category }}</p>
                        </div>
                        <div class="event-info-item">
                            <h3>Price</h3>
                            <p>{{ event.price }}</p>
                        </div>
                        <div class="event-info-item">
                            <h3>Organizer</h3>
                            <p>{{ event.organizer }}</p>
                        </div>
                        <div class="event-info-item">
                            <h3>Available Tickets</h3>
                            <p>{{ event.tickets_available }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="registration-container">
                    <div class="registration-form card">
                        <h2>Register Now</h2>
                        <p style="color: #505050; font-size: 14px; margin-bottom: 20px; background-color: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 3px solid #28a745;">
                            <i class="fas fa-info-circle" style="color: #28a745; margin-right: 5px;"></i>
                            <strong>You'll receive Confirmation and all updates via SMS and Email</strong>
                        </p>
                        <form method="POST" enctype="multipart/form-data" id="registration-form">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="name">Full Name</label>
                                <input type="text" id="name" name="name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="tickets">Number of Tickets</label>
                                <input type="number" id="tickets" name="tickets" min="1" max="10" value="1" class="form-control" required>
                            </div>
                            
                            <div class="payment-instructions">
                                <h3 style="font-size: 20px; margin-bottom: 18px; color: #333; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">Secure Payment</h3>
                                
                                <!-- Total Amount at Top with enhanced styling -->
                                <div style="text-align: center; margin-bottom: 18px; background-color: #f8f9fa; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                                    <p style="font-size: 14px; font-weight: 500; margin-bottom: 4px; color: #555;">Total Amount:</p>
                                    <p id="total-amount" style="font-size: 24px; font-weight: bold; background-color: #28a745; color: white; padding: 4px 12px; border-radius: 6px; margin: 0 auto; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">{{ event.price }}</p>
                                </div>
                                
                                <!-- Enhanced QR Section -->
                                <div style="text-align: center; margin-bottom: 18px; background-color: #fff; border: 1px solid #eaeaea; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                    <p style="margin-bottom: 10px; font-size: 14px; color: #444; font-weight: 500;">
                                        <i class="fas fa-shield-alt" style="color: #28a745; margin-right: 5px;"></i> Scan QR to Pay Securely
                                    </p>
                                    <div id="qrcode" style="background-color: #fff; padding: 15px; display: inline-block; border-radius: 8px; border: 1px solid #eee; margin-bottom: 2px;"></div>
                                    <!-- Recipient Name -->
                                    <p style="margin-top: 1px; font-size: 13px; color: #444; font-weight: 500;">
                                        NAME: <span style="color: #000; font-weight: 600;">SYED TEST</span>
                                    </p>
                                    
                                    <!-- UPI Apps below QR code -->
                                    <div style="display: flex; justify-content: center; gap: 15px; margin: 5px 0 10px 0;">
 
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Google_Pay_Logo.svg/512px-Google_Pay_Logo.svg.png" alt="Google Pay" style="width: 25px; height: 25px; object-fit: contain;">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/PhonePe_Logo.svg/1024px-PhonePe_Logo.svg.png" alt="PhonePe" style="width: 25px; height: 25px; object-fit: contain;">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Paytm_Logo_%28standalone%29.svg/1280px-Paytm_Logo_%28standalone%29.svg.png" alt="Paytm" style="width: 25px; height: 25px; object-fit: contain;">
                                    </div>
                                    
                                    <button id="download-qr" type="button" onclick="downloadQR()" style="background-color: #7928ca; color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(121,40,202,0.2);">
                                        <i class="fas fa-download"></i> Download QR
                                    </button>
                                    
                                </div>
                                
                                <!-- OR separator with enhanced styling -->
                                <div style="text-align: center; margin: 20px 0;">
                                    <div style="display: flex; align-items: center; justify-content: center; max-width: 280px; margin: 0 auto;">
                                        <div style="flex-grow: 1; height: 1px; background-color: #e0e0e0;"></div>
                                        <div style="margin: 0 15px; font-weight: 500; color: #666; font-size: 13px;">OR</div>
                                        <div style="flex-grow: 1; height: 1px; background-color: #e0e0e0;"></div>
                                    </div>
                                </div>
                                
                                <!-- UPI ID with copy button - enhanced styling -->
                                <div style="text-align: center; margin-bottom: 20px; background-color: #f8f9fa; border: 1px solid #eaeaea; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                    <p style="margin-bottom: 8px; font-size: 14px; color: #444; font-weight: 500;">
                                        <i class="fas fa-money-bill-wave" style="color: #28a745; margin-right: 5px;"></i> Pay via UPI ID
                                    </p>
                                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 5px;">
                                        <input id="upi-id" value="tournament@ybl" readonly style="background-color: white; border: 1px solid #ddd; border-radius: 4px 0 0 4px; padding: 10px; text-align: center; width: 180px; font-weight: 500;">
                                        <button onclick="copyUpiId()" style="background-color: #f1f1f1; border: 1px solid #ddd; border-left: none; border-radius: 0 4px 4px 0; padding: 10px 12px; cursor: pointer; transition: all 0.2s ease-in-out;">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <!-- Recipient Name -->
                                    <p style="margin-top: 8px; font-size: 13px; color: #444; font-weight: 500;">
                                        NAME: <span style="color: #000; font-weight: 600;">SYED TEST</span>
                                    </p>
                                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Pay from any UPI app by entering this ID</p>
                                    
                                </div>
                                
                                <!-- Trust indicators -->
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center;">
                                            <i class="fas fa-lock" style="color: #28a745; margin-right: 5px;"></i>
                                            <span style="font-size: 12px; color: #666;">Secure Payment</span>
                                        </div>
                                        <div style="display: flex; align-items: center;">
                                            <i class="fas fa-check-circle" style="color: #28a745; margin-right: 5px;"></i>
                                            <span style="font-size: 12px; color: #666;">Verified Merchant</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <p class="payment-note" style="text-align: center; font-size: 13px; color: #555; background-color: #fafafa; padding: 10px; border-radius: 6px; margin-top: 15px;">After making payment, upload the screenshot below.</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="payment_screenshot">Payment Screenshot</label>
                                <input type="file" id="payment_screenshot" name="payment_screenshot" class="form-control" accept="image/*" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Submit Registration</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Success Modal -->
    <div class="modal" id="success-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="success-message">
                <i class="fas fa-check-circle"></i>
                <h3>Registration Submitted Successfully!</h3>
                <p>Thank you for registering for this tournament!</p>
                <div style="background-color: #f7f7f7; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: left;">
                    <p style="margin-bottom: 10px; color: #333; font-weight: 600;">What happens next?</p>
                    <ul style="padding-left: 20px; margin-bottom: 0;">
                        <li style="margin-bottom: 8px;">You'll receive a confirmation <strong>SMS</strong> and <strong>email</strong> once approved</li>
                    </ul>
                </div>
                <div class="modal-actions">
                    <button id="register-another" class="btn btn-outline">Register Another</button>
                    <a href="{% url 'home' %}" class="btn btn-primary">Back to Home</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<!-- Use CDN version of qrcodejs library -->
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate total based on number of tickets
        const ticketsInput = document.getElementById('tickets');
        const totalAmount = document.getElementById('total-amount');
        const priceText = '{{ event.price }}';
        // Extract just the number value, removing currency symbols or commas
        const price = parseInt(priceText.replace(/[^0-9]/g, ''));
        
        // Format number with commas for thousands separator
        function formatNumberWithCommas(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Set initial price with INR symbol
        if (totalAmount) {
            totalAmount.textContent = '₹' + formatNumberWithCommas(price);
            // Generate initial QR code
            generateQR(price);
        }
        
        // Initialize QR code for payment
        function generateQR(amount) {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = ''; // Clear previous QR code
            
            // Create QR code with UPI payment information
            const upiData = `upi://pay?pa=tournament@ybl&pn=TournamentCentral&am=${amount}&cu=INR`;
            
            // Generate the QR code using qrcodejs library
            try {
                new QRCode(qrContainer, {
                    text: upiData,
                    width: 180,
                    height: 180,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (error) {
                console.error("QR code generation error:", error);
                // Fallback text if QR code fails
                qrContainer.innerHTML = '<div style="height: 150px; display: flex; align-items: center; justify-content: center;"><p style="margin: 0; font-size: 14px;">UPI: tournament@ybl</p></div>';
            }
        }
        
        // Add global functions for the onclick handlers
        window.downloadQR = function() {
            const qrContainer = document.getElementById('qrcode');
            const img = qrContainer.querySelector('img');
            const canvas = qrContainer.querySelector('canvas');
            
            if (img) {
                // Create a temporary link for download
                const link = document.createElement('a');
                link.href = img.src;
                link.download = 'payment-qr.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else if (canvas) {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = 'payment-qr.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };
        
        window.copyUpiId = function() {
            const upiInput = document.getElementById('upi-id');
            upiInput.select();
            document.execCommand('copy');
            
            // Show feedback
            const copyButton = upiInput.nextElementSibling;
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fas fa-check"></i> Copied';
            
            // Reset after 2 seconds
            setTimeout(function() {
                copyButton.innerHTML = originalText;
            }, 2000);
        };
        
        if (ticketsInput && totalAmount) {
            // Update price on change
            ticketsInput.addEventListener('change', updatePrice);
            // Also update on input for immediate feedback
            ticketsInput.addEventListener('input', updatePrice);
            
            function updatePrice() {
                // Get ticket count with fallback to 1 if invalid
                const tickets = parseInt(ticketsInput.value) || 1;
                // Calculate total price
                const total = tickets * price;
                // Update display with INR symbol and formatted number
                totalAmount.textContent = '₹' + formatNumberWithCommas(total);
                // Update QR code with new amount
                generateQR(total);
            }
        }
        
        // Form submission and modal handling
        const form = document.getElementById('registration-form');
        const modal = document.getElementById('success-modal');
        const closeModal = document.querySelector('.close-modal');
        const registerAnother = document.getElementById('register-another');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                // Only prevent default if we're handling the submission via AJAX
                // e.preventDefault();
                
                // Validate form
                if (!form.checkValidity()) {
                    e.preventDefault();
                    form.reportValidity();
                    return;
                }
                
                // Get form data
                const formData = new FormData(form);
                
                // Update modal with user's name
                const nameInput = document.getElementById('name');
                if (nameInput) {
                    const welcomeMsg = document.querySelector('.success-message p');
                    if (welcomeMsg) {
                        welcomeMsg.innerHTML = `Thank you <strong>${nameInput.value}</strong> for registering for this tournament!`;
                    }
                }
                
                // Show spinner or loading indicator
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                submitBtn.disabled = true;
                
                // For demo purposes we're letting the form submit normally
                // This will allow the server-side Django view to handle the form data
                
                // Show the success modal after form submission
                // This will only happen if the form fails validation and doesn't submit
                {% if submitted %}
                setTimeout(function() {
                    modal.style.display = 'flex';
                }, 500);
                {% endif %}
            });
        }
        
        // Close modal when clicking the X
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
        
        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Register another button - reset form and close modal
        if (registerAnother) {
            registerAnother.addEventListener('click', function() {
                form.reset();
                modal.style.display = 'none';
                
                // Reset file input (it's not cleared by form.reset())
                const fileInput = document.getElementById('payment_screenshot');
                if (fileInput) {
                    fileInput.value = '';
                }
                
                // Reset total amount display and QR code
                if (totalAmount) {
                    totalAmount.textContent = '₹' + formatNumberWithCommas(price);
                    generateQR(price);
                }
                
                // Scroll to registration form
                const registrationForm = document.querySelector('.registration-form');
                if (registrationForm) {
                    registrationForm.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
        
        // Show modal on page load if submitted is true (for non-AJAX form submissions)
        {% if submitted %}
        if (modal) {
            modal.style.display = 'flex';
        }
        {% endif %}
    });
</script>
{% endblock %} 